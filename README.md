# Leo Kotlin Runtime

This project contains runtime components that are required by Kotlin code generated by Leo as well as Android and Ktor projects.

## Using Leo-Runtime in Your Project

Artifacts for Leo-Runtime are available in SuryaDigital’s [Artifactory](https://artifacts.surya-digital.in/#browse/browse:maven-public:com%2Fsuryadigital%2Fleo).

You need to set up [version catalog](https://docs.gradle.org/current/userguide/platforms.html#sub:central-declaration-of-dependencies) in your project to use the runtime libraries.

Information on how to use version catalog can be found [here](https://docs.gradle.org/current/userguide/platforms.html#sec:version-catalog-plugin).

The entire leo-runtime can be brought in by adding this to your `dependencies` block in your `build.gradle`:

```groovy
dependencies {
    // Using version catalog
    implementation libs.leo.runtime
    // Without version catalog
    implementation 'com.suryadigital.leo:leo-runtime:$leo_runtime'
}
```

For version catalog, `libs` is the default version catalog accessor used by Gradle to provide type-safe access to all the versions, libraries and plugins defined the catalog.

You can see all the versions, libraries and plugins that are not a runtime module defined in version catalog [here](gradle/libs.versions.toml).

If you are not using version catalog, the `leo_runtime` version should be defined in `gradle.properties`.

To find the latest released version, go to the [releases](https://github.com/SuryaDigital/LeoKotlinRuntime/tags) page.

If you wish to bring in only parts of leo runtime, you can do that as well by using one of these artifacts:

```groovy
dependencies {
    // Using version catalog
    implementation libs.leo.basedb // Only brings in the basedb depdendency
    implementation libs.leo.librpc // Only brings in the librpc depdendency
    // Without version catalog
    implementation 'com.suryadigital.leo:basedb:$leo_runtime' // Only brings in the basedb depdendency
    implementation 'com.suryadigital.leo:librpc:$leo_runtime' // Only brings in the librpc depdendency
}
```

The versions of `leo-runtime`, `basedb`, and `librpc` are all synced. You can find the list of released versions on the [releases](https://github.com/surya-soft/LeoKotlinRuntime/releases) page.

## Development Setup

The project is developed with [IntelliJ IDEA](https://www.jetbrains.com/idea/). The Community Edition (which is free) will do, Ultimate Edition is not required. Also ensure your system has [Temurin-17 JDK](https://adoptium.net/temurin/archive/?version=17) installed. You will also need [git](https://git-scm.com) and [Git LFS](https://git-lfs.github.com) installed.

Clone this repository. Note that this project uses [Git LFS](https://git-lfs.github.com). You should therefore have Git LFS installed on your system before you clone the repository.

## Formatting

### Code - Ktlint

This project enforces a consistent style of code formatting via [ktlint](https://github.com/pinterest/ktlint). You can configure IDEA to use the same settings by following these [instructions](https://github.com/pinterest/ktlint#-with-intellij-idea). After you’ve set up IDEA to follow ktlint’s standards, you can reformat code with IDEA’s reformatting tool, and you should be good to go.

There is, however, an easier way to do this across the entire project. Run the command `./gradlew spotlessApply` from the root of the repository. This will automatically ensure that all the files in the project are formatted according to the standard.

### Documentation

All documentation is written in [GitHub Flavored Markdown](https://github.github.com/gfm/).

Markdown is formatted with [Prettier](https://prettier.io) to ensure consistency.

You can set up [Prettier in VS Code](https://github.com/prettier/prettier-vscode) for convenience.

## Adding Modules

Whenever a new module is added to the `LeoKotlinRuntime`, a few extra steps are required to be performed.

### Leo-Runtime

`leo-runtime` is a module in `LeoKotlinRuntime` which exposes all the other modules as APIs.

This allows us to directly import all the runtime modules inside a project, as well as create a `shadowJar` of all the modules in `LeoKotlinRuntime`.

Thus, when a new module is introduced, it should be added as an `api(project())` in [`leo-runtime/build.gradle.kts`](leo-runtime/build.gradle.kts).

For example, if a new module called `example` is created in `LeoKotlinRuntime`, we need to add the following code to [`leo-runtime/build.gradle.kts`](leo-runtime/build.gradle.kts):

```kotlin
dependencies {
    // Other module definitions
    api(project(":example"))
    // Other module definitions
}
```

### Version Catalog

If you are adding a new module to `LeoKotlinRuntime`, the same module must be defined in the version catalog so that other projects can import the module from the catalog.

You can do this my defining the module in `catalog` > `versionCatalog` block in [build.gradle.kts](build.gradle.kts).

For example, if you create a module called `example`, it should be added to [build.gradle.kts](build.gradle.kts) in the following manner:

```kotlin
catalog {
    versionCatalog {
        version("leo", leoVersion)
        // Other module definitions
        library("leo-example", leoGroup, "example").versionRef("leo") // <-- The line that should be added.
        // Other module definitions
        plugin("leo-plugin", "$leoGroup.plugins").versionRef("leo")
        from(files("${rootProject.projectDir}/gradle/libs.versions.toml"))
    }
}
```

> [!NOTE]
> All the modules should be appended with `leo-` in catalog definition to make it easier to identify LeoKotlinRuntime libraries.

## Updating Dependency Versions

To update dependency versions interactively in the version catalog, the following command can be used:

```shell
./gradlew versionCatalogUpdate --interactive
```

This will create a new file called [libs.versions.updates.toml](/gradle/libs.versions.updates.toml), that will contain the information on what dependency updates are available, and the version those dependencies can be updated to.

Follow the instruction given in the [libs.versions.updates.toml](/gradle/libs.versions.updates.toml) file to selectively update certain dependencies, by removing the ones that you do not want to be updated. Then you can use the command:

```shell
./gradlew versionCatalogApplyUpdates
```

to update the versions of those dependencies.

More information about the plugin that handles version updates can be found [here](https://github.com/littlerobots/version-catalog-update-plugin).

> [!WARNING]
> The plugin cannot differentiate whether a version is stable, alpha, beta or a release candidate.
> It will see the latest version available, and assign it as the version to which the dependecy should be updated.
>
> Please go over all the dependency versions carefully before applying the update.
